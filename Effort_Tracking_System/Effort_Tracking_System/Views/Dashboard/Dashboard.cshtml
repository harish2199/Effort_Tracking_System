@model List<Effort_Tracking_System.user_task_assignment>

@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Effort Tracking System</title>
    @*<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">*@
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Allocate Effort
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="form-group">
                                <label for="projectSelect">Select Project</label>
                                <select class="form-control" id="projectSelect">
                                    @foreach (var project in ViewBag.Projects)
                                    {
                                        <option value="@project.project_id">@project.name</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskSelect">Select Task</label>
                                <select class="form-control" id="taskSelect">
                                    @*  @foreach (var assignment in ViewBag.Assignments)
                                        {
                                            <option value="@assignment.task_id">@assignment.task_name</option>
                                        }*@
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="shiftSelect">Select Shift</label>
                                <select class="form-control" id="shiftSelect"></select>
                            </div>
                            <div class="form-group">
                                <label for="allocatedHours">Allocated Hours</label>
                                <input type="text" class="form-control" id="allocatedHours" readonly>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- ... Summary... -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Last Week Summary
                    </div>
                    <div class="card-body">
                        <p>Total Allocated Hours: 35</p>
                        <p>Total Completed Hours: 28</p>
                        <p>Remaining Hours: 7</p>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <a href="/Reports/ReportIndex" class="btn btn-secondary">View Previous Report</a>
                </div>
            </div>
        </div>
    </div>
    <script>
    var assignments = @Html.Raw(Json.Encode(ViewBag.Details));

    // Initialize task select options based on selected project
    function populateTaskOptions(projectId) {
        var taskSelect = $("#taskSelect");
        taskSelect.empty();

        assignments.filter(function (assignment) {
            return assignment.project_id === parseInt(projectId);
        }).forEach(function (assignment) {
            taskSelect.append($("<option>").val(assignment.task_id).text(assignment.task_name));
        });

        // Trigger task select change event to populate initial shift and allocated hours
        taskSelect.trigger("change");
    }

    // Function to populate shift and allocated hours based on selected task
    function populateShiftAndHours(taskId) {
        $.ajax({
            url: '/Dashboard/GetTaskDetails',
            type: 'GET',
            data: { taskId: taskId },
            success: function (data) {
                $("#allocatedHours").val(data.hours);

                // Populate the shiftSelect dropdown with shiftName as text
                var shiftSelect = $("#shiftSelect");
                shiftSelect.empty();

                if (data.shiftId !== null) {
                    shiftSelect.append($("<option>").val(data.shiftId).text(data.shiftName));
                } else {
                    shiftSelect.append($("<option>").val(-1).text("No Shift"));
                }
            }
        });
    }
    $(document).ready(function () {
        $("#projectSelect").on("change", function () {
            var projectId = $(this).val();
            populateTaskOptions(projectId);
        });

        $("#taskSelect").on("change", function () {
            var taskId = parseInt($(this).val());
            populateShiftAndHours(taskId);
        });

        // Initialize project select change event
        var initialProjectId = parseInt($("#projectSelect").val());
        populateTaskOptions(initialProjectId);
    });
    </script>


</body>
